<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>

    <script src="public/js/jquery-1.11.2.min.js"></script>

    <link rel="stylesheet" type="text/css" href="public/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="style.css">

  </head>
  <body>
    <header>
        <form action="" id="setupForm">
          <div>
            <label for="ipAddress">IP Address:</label>
            <input type="text" id="ipAddress"/>        
          </div>

          <div>
            <label for="port">Port:</label>
            <input type="text" id="port" />        
          </div>

          <div>
            <label for="role">Server:</label>
            <input type="radio" id="role" name="role" value="server" checked="checked"/>
            <label for="role">Client:</label>
            <input type="radio" id="role" name="role" value="client" />         
          </div>

          <div class="button">
            <button type="submit">Start</button>
          </div>
        </form>
        <button name="restart">Restart</button>
    </header>


    <main>
      <table id="tictactoe">
          <tr id="row0" data-row="0" class="tictactoe-row">
            <td><button class="xo" id="col0" data-col="0" value=0 ></button></td>
            <td><button class="xo" id="col1" data-col="1" value=0 ></button></td>
            <td><button class="xo" id="col2" data-col="2" value=0 ></button></td>
          </tr>
          <tr id="row1" data-row="1" class="tictactoe-row">
            <td><button class="xo" id="col0" data-col="0" value=0 ></button></td>
            <td><button class="xo" id="col1" data-col="1"></button></td>
            <td><button class="xo" id="col2" data-col="2"></button></td>
          </tr>
          <tr id="row2" data-row="2" class="tictactoe-row">
            <td><button class="xo" id="col0" data-col="0"></button></td>
            <td><button class="xo" id="col1" data-col="1"></button></td>
            <td><button class="xo" id="col2" data-col="2" ></button></td>
          </tr>
        </table>
    </main>
    

    <div id="chat-sidecart">
        <ul id="chat-msgbox">
            <li class="chat-msg">Hey uadfadsfassfadsfadsf adsfasdfasdf asdfadsf asdfasdffasdfadssaf asdfasdfadsfadsfaadsfadsfadsf pwassupwupwassupsup</li>
            <li class="chat-msg"></li>
            <li class="chat-msg"></li>
        </ul>
        <form action="" id="chat-input">
            <input id="m" autocomplete="off" type="text" />
            <button>Send</button>
        </form>
    </div>


    <script type="text/javascript" src="public/js/bootstrap.min.js"></script>
    <script src="public/js/socket.io.js"></script>
    <script type="text/javascript" src="app.js"></script>
    <script>
      var role;
      var ip;
      var port;
      var client_socket;
      $('form#setupForm').submit(function(){
        role = $('input[name=role]:checked', '#setupForm').val();
        ip = $('#ipAddress').val();
        port = $('#port').val();

        if (role === "server"){
          //is server
        
          //if not running -> start listening
          http.listen( port, function(){
            console.log('listening on *:' + port);
          });

          client_socket = io('http://localhost:' + port);
          // client_socket = io('http://localhost:3000');
        } else {
          //is client
          console.log("I'm the client");
          if (!client_socket){
            //If doesn't exist, create a new one and connect
            client_socket = io('http://' + ip + ':' + port );
          } else {
            if ( client_socket.disconnected ) {
              // If not connected, connect
              client_socket.connect('http://localhost:' +port, {forceNew: true});
            } else {
              // If connected, disconnect
              client_socket.disconnect();
            }
          }
        }

        if(client_socket) {
          //Change connect button to Disconnect
          if( role === "server"){
            $('form#setupForm button').html('Stop');
          } else {
            $('form#setupForm button').html('Disconnect');
          }
        }

        /*
          Chat
        */
        
        console.log("client socket = " + client_socket);
        client_socket.on('chat message', function(msg){
          $('#messages').append($('<li>').text(msg));
        }); 

        /*
          Update Board
        */
        client_socket.on('board update', function(data){
          console.log(data);
          var move = data.move;
          var mover = data.by;

          var selector = "#row"+move[0]+" #col"+move[1];
          console.log("updating: " + selector +" by " + mover);

          if ( mover === "server" ) {
            $(selector).addClass('serverMove');
          } else {
            $(selector).addClass('clientMove');
          }

        });
        /*
          Gameover
        */
        client_socket.on('gameover', function(data){
          alert(data.winner + " won!");
          reset_board();
        });

        client_socket.on('error', function(msg){
          alert(msg);
        });

        return false;
      });

    	$('form#chat').submit(function(){
        if (client_socket) {
          console.log("submitting chat");
          client_socket.emit('chat message', $('#m').val());
          $('#m').val('');
        }
    		return false;
    	});

      $('button.xo').on('click', function(e){
        var row = $(this).parent().parent().data('row');
        var col = $(this).data('col');
        console.log(row +','+col);

        var data = {
          move: [row,col]
        }
        $(this).addClass(role+'Move');
        client_socket.emit( role +' move', data );
      })

      $('button[name=restart]').on('click', function(e){
        reset_board();
        client_socket.emit('restart', '');
      });

      $('form#setupForm input[type=radio]').on('click', function(e){
        var role = $('input[name=role]:checked', '#setupForm').val();
        if( role === "server"){
          $('form#setupForm button').html('Start');
        } else {
          $('form#setupForm button').html('Connect');
        }
      });

      var reset_board = function(){
        $('button.xo').attr('class', 'xo');
      }
    </script>

  </body>
</html>